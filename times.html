<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ILMIFY || Prayer Times</title>
    <meta name="description" content="Get accurate prayer times based on search.">
    <meta name="keywords" content="prayer times, salah times, namaz times, islamic prayer times">
    <meta name="author" content="ilmify Pious Brothers Team">
    <link rel="stylesheet" href="pbc.css">
    <link rel="icon" href="logoo.png" type="image/icon type">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Anek+Latin:wght@400;700&display=swap" rel="stylesheet">
    <script src="auth.js"></script>
    <style>
        .prayer-card {
            background: linear-gradient(145deg, #0d564f, #063e39);
            border-radius: 15px;
            padding: 20px;
            margin: 10px;
            color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .prayer-time-row {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .prayer-time-row:last-child {
            border-bottom: none;
        }

        .prayer-name {
            font-weight: bold;
            font-size: 1.2rem;
        }

        .time-value {
            font-size: 1.2rem;
            font-family: 'Anek Latin', monospace;
        }

        .location-info {
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: #ccc;
        }

        #loader {
            display: none;
        }

        /* Pulse animation for the loader icon if needed */
        .fa-spin-pulse {
            animation: fa-spin 1s infinite steps(8);
        }

        .settings-panel {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
    </style>
</head>

<body class="black">
    <header class="fix intro" style="z-index: 1000;">
        <center>
            <a style="position: fixed; left: 20px; color: rgb(251, 249, 249);" href="/main.html"><i
                    class="fa fa-home"></i></a>
            PRAYER TIMES
        </center>
    </header>
    <br><br><br>

    <div class="content intro">
        <center>
            <div class="prayer-card" style="max-width: 500px;">
                <h3 class="title p-2" style="background: transparent;">Prayer Times</h3>

                <div class="settings-panel">
                    <div style="text-align: left; margin-bottom: 5px; font-size: 0.8rem; color: #aaa;">Search Location
                    </div>
                    <div class="d-flex gap-2">
                        <input type="text" id="cityInput" class="form-control" style="background-color: #afe9da;"
                            placeholder="City (e.g. checked)">
                        <input type="text" id="countryInput" class="form-control" style="background-color: #afe9da;"
                            placeholder="Country (e.g. INDIA)">
                    </div>

                    <button class="btn btn-success w-100 mt-2" onclick="saveAndFetch()">Get Prayer Times</button>
                </div>

                <div id="locationDisplay" class="location-info">
                    <i class="fa fa-map-marker-alt"></i> <span id="locText">Enter location above</span>
                </div>

                <div id="prayerData" style="display: none;">
                    <div class="prayer-time-row">
                        <span class="prayer-name">Fajr</span>
                        <span class="time-value" id="fajrTime">--:--</span>
                    </div>
                    <div class="prayer-time-row">
                        <span class="prayer-name">Sunrise</span>
                        <span class="time-value" id="sunriseTime">--:--</span>
                    </div>
                    <div class="prayer-time-row">
                        <span class="prayer-name">Dhuha</span>
                        <span class="time-value" id="dhuhaTime">--:--</span>
                    </div>
                    <div class="prayer-time-row">
                        <span class="prayer-name">Dhuhr</span>
                        <span class="time-value" id="dhuhrTime">--:--</span>
                    </div>
                    <div class="prayer-time-row">
                        <span class="prayer-name">Asr</span>
                        <span class="time-value" id="asrTime">--:--</span>
                    </div>
                    <div class="prayer-time-row">
                        <span class="prayer-name">Maghrib</span>
                        <span class="time-value" id="maghribTime">--:--</span>
                    </div>
                    <div class="prayer-time-row">
                        <span class="prayer-name">Isha</span>
                        <span class="time-value" id="ishaTime">--:--</span>
                    </div>
                    <div class="prayer-time-row">
                        <span class="prayer-name">First Third</span>
                        <span class="time-value" id="firstThirdTime">--:--</span>
                    </div>
                    <div class="prayer-time-row">
                        <span class="prayer-name">Midnight</span>
                        <span class="time-value" id="midnightTime">--:--</span>
                    </div>
                    <div class="prayer-time-row">
                        <span class="prayer-name">Last Third</span>
                        <span class="time-value" id="lastThirdTime">--:--</span>
                    </div>
                </div>

                <div id="loader" style="margin: 20px;">
                    <i class="fa-solid fa-spinner fa-spin fa-2x"></i>
                    <p style="margin-top: 10px;">Fetching prayer times...</p>
                </div>

                <div id="errorMsg" style="display: none; color: #ff6b6b; margin: 10px;">
                    <i class="fa fa-exclamation-circle"></i> <span id="errorText"></span>
                </div>
            </div>

            <p class="text-white mt-3" style="font-size: 0.8rem; opacity: 0.7;">
                Calculation Method: University of Islamic Sciences, Karachi

            </p>
        </center>
    </div>

    <script src="pbc.js"></script>
    <script>
        // State
        let userSettings = {
            city: '',
            country: ''
        };

        // Hardcoded Method: 1 = University of Islamic Sciences, Karachi
        const CALCULATION_METHOD = 1;

        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
            init();
        });

        function loadSettings() {
            const saved = localStorage.getItem('prayerSettings_v4'); // v4 for manual-only
            if (saved) {
                userSettings = JSON.parse(saved);
                document.getElementById('cityInput').value = userSettings.city || '';
                document.getElementById('countryInput').value = userSettings.country || '';
            }
        }

        function saveSettings() {
            userSettings.city = document.getElementById('cityInput').value.trim();
            userSettings.country = document.getElementById('countryInput').value.trim();
            localStorage.setItem('prayerSettings_v4', JSON.stringify(userSettings));
        }

        function init() {
            if (userSettings.city) fetchManualTimes();
        }

        function saveAndFetch() {
            saveSettings();
            if (!userSettings.city) {
                alert("Please enter a city name.");
                return;
            }
            fetchManualTimes();
        }

        function getCommonDateString() {
            const date = new Date();
            // Using DD-MM-YYYY
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}-${month}-${year}`;
        }

        function fetchManualTimes() {
            const city = document.getElementById('cityInput').value;
            const country = document.getElementById('countryInput').value;
            const loader = document.getElementById('loader');
            const prayerData = document.getElementById('prayerData');
            const errorMsg = document.getElementById('errorMsg');

            if (!city) return;

            prayerData.style.display = 'none';
            errorMsg.style.display = 'none';
            loader.style.display = 'block';
            document.getElementById('locText').innerText = `Searching for ${city}...`;

            const apiUrl = `https://api.aladhan.com/v1/timingsByCity?city=${encodeURIComponent(city)}&country=${encodeURIComponent(country)}&method=${CALCULATION_METHOD}`;

            fetch(apiUrl)
                .then(response => response.json())
                .then(data => handleApiResponse(data))
                .catch(err => {
                    handleApiError(err);
                });
        }

        function handleApiResponse(data) {
            if (data.code === 200 && data.data) {
                displayTimes(data.data);
            } else {
                throw new Error("API call failed or returned no data");
            }
        }

        function handleApiError(err) {
            const loader = document.getElementById('loader');
            const errorMsg = document.getElementById('errorMsg');
            loader.style.display = 'none';
            errorMsg.style.display = 'block';
            document.getElementById('errorText').innerText = "Failed to fetch prayer data. " + err.message;
        }

        function displayTimes(data) {
            const timings = data.timings;
            // const meta = data.meta;

            document.getElementById('fajrTime').innerText = convertTo12Hour(timings.Fajr);
            document.getElementById('sunriseTime').innerText = convertTo12Hour(timings.Sunrise);
            document.getElementById('dhuhrTime').innerText = convertTo12Hour(timings.Dhuhr);
            document.getElementById('asrTime').innerText = convertTo12Hour(timings.Asr);
            document.getElementById('maghribTime').innerText = convertTo12Hour(timings.Maghrib);
            document.getElementById('ishaTime').innerText = convertTo12Hour(timings.Isha);

            // Extra times
            // Custom Salaf Calculation for Night Times (Maghrib to Fajr)
            calculateAndDisplaySalafTimes(timings.Maghrib, timings.Fajr);

            // Calculate Dhuha (Sunrise + 20 mins)
            if (timings.Sunrise) {
                document.getElementById('dhuhaTime').innerText = calculateDhuha(timings.Sunrise);
            }

            // Update location text
            const city = document.getElementById('cityInput').value;
            const country = document.getElementById('countryInput').value;
            document.getElementById('locText').innerText = `${city}${country ? ', ' + country : ''}`;

            document.getElementById('loader').style.display = 'none';
            document.getElementById('prayerData').style.display = 'block';
        }

        function calculateAndDisplaySalafTimes(maghribTime, fajrTime) {
            // Helper to get minutes from HH:mm
            const getMinutes = (timeStr) => {
                const [h, m] = timeStr.split(' ')[0].split(':').map(Number);
                return h * 60 + m;
            };

            let maghribMin = getMinutes(maghribTime);
            let fajrMin = getMinutes(fajrTime);

            // If Fajr is technically "smaller" than Maghrib, it means it's the next day, so add 24h
            if (fajrMin < maghribMin) {
                fajrMin += 24 * 60;
            }

            const nightDuration = fajrMin - maghribMin;

            // Calculations
            const firstThirdMin = maghribMin + (nightDuration / 3);
            const midnightMin = maghribMin + (nightDuration / 2);
            const lastThirdMin = maghribMin + (2 * nightDuration / 3);

            // Update DOM
            document.getElementById('firstThirdTime').innerText = minutesTo12Hour(firstThirdMin);
            document.getElementById('midnightTime').innerText = minutesTo12Hour(midnightMin);
            document.getElementById('lastThirdTime').innerText = minutesTo12Hour(lastThirdMin);
        }

        function minutesTo12Hour(totalMinutes) {
            // Visualize time over 24h as needed
            let h = Math.floor(totalMinutes / 60);
            let m = Math.floor(totalMinutes % 60);

            // Normalize hours if > 24 (e.g., 25:00 is 1:00 AM)
            if (h >= 24) h -= 24;

            const ampm = h >= 12 ? 'PM' : 'AM';
            h = h % 12;
            h = h ? h : 12; // 0 becomes 12

            return `${h}:${m < 10 ? '0' + m : m} ${ampm}`;
        }

        function calculateDhuha(sunriseTime) {
            // sunriseTime is HH:mm (24h)
            let cleanTime = sunriseTime.split(' ')[0]; // safely handle just in case
            let [hours, minutes] = cleanTime.split(':').map(Number);
            let date = new Date();
            date.setHours(hours);
            date.setMinutes(minutes + 20); // Add 20 minutes

            let h = date.getHours();
            let m = date.getMinutes();

            // Format back to HH:mm string for conversion
            let timeStr = `${h}:${m < 10 ? '0' + m : m}`;
            return convertTo12Hour(timeStr);
        }

        function convertTo12Hour(time) {
            // time format is "HH:mm" (24h)
            let cleanTime = time.split(' ')[0];
            let [hours, minutes] = cleanTime.split(':');
            hours = parseInt(hours);

            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12; // the hour '0' should be '12'

            return `${hours}:${minutes} ${ampm}`;
        }
    </script>
</body>

</html>