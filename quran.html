<!DOCTYPE html>
<html lang="en">

<head>
    <title>Quran Reader - ILMIFY</title>
    <meta name="description" content="Read the Holy Quran with translation and audio. Track your reading progress.">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="pbc.css">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Anek+Latin:wght@400;700&family=Amiri:wght@400;700&family=Noto+Sans+Malayalam:wght@400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body {
            font-family: 'Anek Latin', sans-serif;
            background:
                radial-gradient(circle at 30% 30%, #0d564f, transparent 40%),
                radial-gradient(circle at 70% 40%, #0d564f, transparent 40%),
                radial-gradient(circle at 50% 70%, #0d564f, transparent 40%);
            background-color: #00060f;
            background-attachment: fixed;
            color: #fff;
            min-height: 100vh;
        }

        .quran-container {
            max-width: 900px;
            margin: 30px auto;
            padding: 20px;
        }

        /* Nav & Banner Styles */
        .resume-banner {
            background: linear-gradient(135deg, #0d564f, #1a7a70);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            display: none;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 8px 20px rgba(13, 86, 79, 0.3);
            animation: slideDown 0.5s ease-out;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .surah-selector {
            background: rgba(13, 86, 79, 0.1);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid rgba(13, 86, 79, 0.3);
        }

        .surah-selector label {
            font-size: 1.1rem;
            font-weight: bold;
            color: #1a7a70;
            margin-bottom: 10px;
            display: block;
        }

        .surah-selector select {
            width: 100%;
            padding: 12px 15px;
            border-radius: 10px;
            border: 2px solid #0d564f;
            background: white;
            color: #000;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .surah-selector select:focus {
            outline: none;
            border-color: #1a7a70;
            box-shadow: 0 0 0 3px rgba(13, 86, 79, 0.1);
        }

        /* Ayah Display Styles */
        .ayah-display {
            background: linear-gradient(135deg, rgba(13, 86, 79, 0.05), rgba(26, 122, 112, 0.05));
            padding: 40px;
            border-radius: 20px;
            margin-bottom: 30px;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border: 2px solid rgba(13, 86, 79, 0.2);
            position: relative;
            overflow: hidden;
        }

        .ayah-display::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(13, 86, 79, 0.03) 0%, transparent 70%);
            animation: pulse 8s ease-in-out infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        .ayah-number {
            background: linear-gradient(135deg, #0d564f, #1a7a70);
            color: white;
            padding: 8px 20px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(13, 86, 79, 0.3);
            position: relative;
            z-index: 1;
        }

        .ayah-arabic {
            font-family: 'Amiri', serif;
            font-size: 2.8rem;
            line-height: 2.2;
            text-align: center;
            color: #000000;
            margin: 20px 0;
            direction: rtl;
            position: relative;
            z-index: 1;
            background-color: #ffffff;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .ayah-translation {
            font-size: 1.2rem;
            line-height: 1.8;
            text-align: center;
            color: #b3b2b2;
            font-style: italic;
            max-width: 700px;
            position: relative;
            z-index: 1;
        }

        /* Audio Player Styling */
        .audio-wrapper {
            text-align: center;
            margin: 20px auto 30px;
            position: relative;
            z-index: 1;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 15px;
            border-radius: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            max-width: 400px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        audio {
            width: 100%;
            height: 35px;
            outline: none;
            /* Removed filter to ensure visibility on all browsers */
        }

        .play-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #1a7a70, #0d564f);
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(26, 122, 112, 0.4);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .play-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(26, 122, 112, 0.6);
        }

        .play-btn:active {
            transform: scale(0.95);
        }

        /* Custom Nav Styles */
        .nav {
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
            color: rgb(252, 251, 251);
            padding: 20px;
            font-family: "anek latin", sans-serif;
            background: linear-gradient(to bottom, transparent, #0d564f8c);
        }

        .navigation-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
        }

        .nav-btn {
            background: linear-gradient(135deg, #0d564f, #1a7a70);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(13, 86, 79, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(13, 86, 79, 0.4);
        }

        .nav-btn:active {
            transform: translateY(0);
        }

        .nav-btn:disabled {
            background: linear-gradient(135deg, #6c757d, #5a6268);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #ffffff;
            font-size: 1.2rem;
        }

        .loading i {
            font-size: 2rem;
            margin-bottom: 15px;
            display: block;
        }

        .surah-info {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(13, 86, 79, 0.05);
            border-radius: 10px;
            position: relative;
            z-index: 1;
        }

        .surah-info h3 {
            color: #fbffff;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .surah-info p {
            color: #98beba;
            margin: 0;
            font-size: 0.9rem;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @media (max-width: 768px) {
            .ayah-arabic {
                font-size: 1.8rem;
                line-height: 2;
            }

            .ayah-translation {
                font-size: 1rem;
            }

            .ayah-display {
                padding: 25px;
                min-height: 350px;
            }

            .nav-btn {
                padding: 12px 20px;
                font-size: 0.9rem;
            }
        }
    </style>
    <script src="guest-utils.js"></script>
</head>

<body>
    <header class="fix intro" style="z-index: 1000;">
        <center>
            <a style="position: fixed; left: 20px; color: rgb(251, 249, 249);" href="/main.html"><i
                    class="fa fa-home"></i></a>
            Quran
        </center>
    </header><br><br><br>

    <div class="quran-container">
        <div class="resume-banner" id="resumeBanner">
            <div>
                <h5 class="mb-1"><i class="fas fa-bookmark"></i> Continue Reading</h5>
                <p class="mb-0 small" id="resumeText"></p>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-light btn-sm" onclick="resumeReading()">Resume</button>
                <button class="btn btn-outline-light btn-sm" onclick="closeResumeBanner()">Dismiss</button>
            </div>
        </div>

        <div class="surah-selector">
            <label for="surahSelect">Select Surah</label>
            <select id="surahSelect" onchange="loadSurah()">
                <option value="">-- Choose --</option>
            </select>
        </div>

        <div class="ayah-display" id="ayahDisplay">
            <div class="text-center py-5">
                <i class="fas fa-book-open fa-3x mb-3" style="color: #1a7a70;"></i>
                <p>Select a Surah to begin reading</p>
            </div>
        </div>

        <div class="navigation-controls">
            <button class="nav-btn" id="prevBtn" onclick="previousAyah()" disabled>
                <i class="fas fa-arrow-left"></i> Previous
            </button>
            <button class="nav-btn" id="nextBtn" onclick="nextAyah()" disabled>
                Next <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <script>
        // Full Surah List
        const surahNames = [
            { number: 1, arabic: "الفاتحة", english: "Al-Fatihah", translation: "The Opening", verses: 7 },
            { number: 2, arabic: "البقرة", english: "Al-Baqarah", translation: "The Cow", verses: 286 },
            { number: 3, arabic: "آل عمران", english: "Ali 'Imran", translation: "Family of Imran", verses: 200 },
            { number: 4, arabic: "النساء", english: "An-Nisa", translation: "The Women", verses: 176 },
            { number: 5, arabic: "المائدة", english: "Al-Ma'idah", translation: "The Table Spread", verses: 120 },
            { number: 6, arabic: "الأنعام", english: "Al-An'am", translation: "The Cattle", verses: 165 },
            { number: 7, arabic: "الأعراف", english: "Al-A'raf", translation: "The Heights", verses: 206 },
            { number: 8, arabic: "الأنفال", english: "Al-Anfal", translation: "The Spoils of War", verses: 75 },
            { number: 9, arabic: "التوبة", english: "At-Tawbah", translation: "The Repentance", verses: 129 },
            { number: 10, arabic: "يونس", english: "Yunus", translation: "Jonah", verses: 109 },
            { number: 11, arabic: "هود", english: "Hud", translation: "Hud", verses: 123 },
            { number: 12, arabic: "يوسف", english: "Yusuf", translation: "Joseph", verses: 111 },
            { number: 13, arabic: "الرعد", english: "Ar-Ra'd", translation: "The Thunder", verses: 43 },
            { number: 14, arabic: "ابراهيم", english: "Ibrahim", translation: "Abraham", verses: 52 },
            { number: 15, arabic: "الحجر", english: "Al-Hijr", translation: "The Rocky Tract", verses: 99 },
            { number: 16, arabic: "النحل", english: "An-Nahl", translation: "The Bee", verses: 128 },
            { number: 17, arabic: "الإسراء", english: "Al-Isra", translation: "The Night Journey", verses: 111 },
            { number: 18, arabic: "الكهف", english: "Al-Kahf", translation: "The Cave", verses: 110 },
            { number: 19, arabic: "مريم", english: "Maryam", translation: "Mary", verses: 98 },
            { number: 20, arabic: "طه", english: "Taha", translation: "Ta-Ha", verses: 135 },
            { number: 21, arabic: "الأنبياء", english: "Al-Anbya", translation: "The Prophets", verses: 112 },
            { number: 22, arabic: "الحج", english: "Al-Hajj", translation: "The Pilgrimage", verses: 78 },
            { number: 23, arabic: "المؤمنون", english: "Al-Mu'minun", translation: "The Believers", verses: 118 },
            { number: 24, arabic: "النور", english: "An-Nur", translation: "The Light", verses: 64 },
            { number: 25, arabic: "الفرقان", english: "Al-Furqan", translation: "The Criterion", verses: 77 },
            { number: 26, arabic: "الشعراء", english: "Ash-Shu'ara", translation: "The Poets", verses: 227 },
            { number: 27, arabic: "النمل", english: "An-Naml", translation: "The Ant", verses: 93 },
            { number: 28, arabic: "القصص", english: "Al-Qasas", translation: "The Stories", verses: 88 },
            { number: 29, arabic: "العنكبوت", english: "Al-'Ankabut", translation: "The Spider", verses: 69 },
            { number: 30, arabic: "الروم", english: "Ar-Rum", translation: "The Romans", verses: 60 },
            { number: 31, arabic: "لقمان", english: "Luqman", translation: "Luqman", verses: 34 },
            { number: 32, arabic: "السجدة", english: "As-Sajdah", translation: "The Prostration", verses: 30 },
            { number: 33, arabic: "الأحزاب", english: "Al-Ahzab", translation: "The Combined Forces", verses: 73 },
            { number: 34, arabic: "سبإ", english: "Saba", translation: "Sheba", verses: 54 },
            { number: 35, arabic: "فاطر", english: "Fatir", translation: "Originator", verses: 45 },
            { number: 36, arabic: "يس", english: "Ya-Sin", translation: "Ya Sin", verses: 83 },
            { number: 37, arabic: "الصافات", english: "As-Saffat", translation: "Those who set the Ranks", verses: 182 },
            { number: 38, arabic: "ص", english: "Sad", translation: "The Letter 'Saad'", verses: 88 },
            { number: 39, arabic: "الزمر", english: "Az-Zumar", translation: "The Troops", verses: 75 },
            { number: 40, arabic: "غافر", english: "Ghafir", translation: "The Forgiver", verses: 85 },
            { number: 41, arabic: "فصلت", english: "Fussilat", translation: "Explained in Detail", verses: 54 },
            { number: 42, arabic: "الشورى", english: "Ash-Shuraa", translation: "The Consultation", verses: 53 },
            { number: 43, arabic: "الزخرف", english: "Az-Zukhruf", translation: "The Ornaments of Gold", verses: 89 },
            { number: 44, arabic: "الدخان", english: "Ad-Dukhan", translation: "The Smoke", verses: 59 },
            { number: 45, arabic: "الجاثية", english: "Al-Jathiyah", translation: "The Crouching", verses: 37 },
            { number: 46, arabic: "الأحقاف", english: "Al-Ahqaf", translation: "The Wind-Curved Sandhills", verses: 35 },
            { number: 47, arabic: "محمد", english: "Muhammad", translation: "Muhammad", verses: 38 },
            { number: 48, arabic: "الفتح", english: "Al-Fath", translation: "The Victory", verses: 29 },
            { number: 49, arabic: "الحجرات", english: "Al-Hujurat", translation: "The Rooms", verses: 18 },
            { number: 50, arabic: "ق", english: "Qaf", translation: "The Letter 'Qaf'", verses: 45 },
            { number: 51, arabic: "الذاريات", english: "Adh-Dhariyat", translation: "The Winnowing Winds", verses: 60 },
            { number: 52, arabic: "الطور", english: "At-Tur", translation: "The Mount", verses: 49 },
            { number: 53, arabic: "النجم", english: "An-Najm", translation: "The Star", verses: 62 },
            { number: 54, arabic: "القمر", english: "Al-Qamar", translation: "The Moon", verses: 55 },
            { number: 55, arabic: "الرحمن", english: "Ar-Rahman", translation: "The Beneficent", verses: 78 },
            { number: 56, arabic: "الواقعة", english: "Al-Waqi'ah", translation: "The Inevitable", verses: 96 },
            { number: 57, arabic: "الحديد", english: "Al-Hadid", translation: "The Iron", verses: 29 },
            { number: 58, arabic: "المجادلة", english: "Al-Mujadila", translation: "The Pleading Woman", verses: 22 },
            { number: 59, arabic: "الحشر", english: "Al-Hashr", translation: "The Exile", verses: 24 },
            { number: 60, arabic: "الممتحنة", english: "Al-Mumtahanah", translation: "She that is to be examined", verses: 13 },
            { number: 61, arabic: "الصف", english: "As-Saf", translation: "The Ranks", verses: 14 },
            { number: 62, arabic: "الجمعة", english: "Al-Jumu'ah", translation: "The Congregation", verses: 11 },
            { number: 63, arabic: "المنافقون", english: "Al-Munafiqun", translation: "The Hypocrites", verses: 11 },
            { number: 64, arabic: "التغابن", english: "At-Taghabun", translation: "The Mutual Disillusion", verses: 18 },
            { number: 65, arabic: "الطلاق", english: "At-Talaq", translation: "The Divorce", verses: 12 },
            { number: 66, arabic: "التحريم", english: "At-Tahrim", translation: "The Prohibition", verses: 12 },
            { number: 67, arabic: "الملك", english: "Al-Mulk", translation: "The Sovereignty", verses: 30 },
            { number: 68, arabic: "القلم", english: "Al-Qalam", translation: "The Pen", verses: 52 },
            { number: 69, arabic: "الحاقة", english: "Al-Haqqah", translation: "The Reality", verses: 52 },
            { number: 70, arabic: "المعارج", english: "Al-Ma'arij", translation: "The Ascending Stairways", verses: 44 },
            { number: 71, arabic: "نوح", english: "Nuh", translation: "Noah", verses: 28 },
            { number: 72, arabic: "الجن", english: "Al-Jinn", translation: "The Jinn", verses: 28 },
            { number: 73, arabic: "المزمل", english: "Al-Muzzammil", translation: "The Enshrouded One", verses: 20 },
            { number: 74, arabic: "المدثر", english: "Al-Muddaththir", translation: "The Cloaked One", verses: 56 },
            { number: 75, arabic: "القيامة", english: "Al-Qiyamah", translation: "The Resurrection", verses: 40 },
            { number: 76, arabic: "الانسان", english: "Al-Insan", translation: "The Man", verses: 31 },
            { number: 77, arabic: "المرسلات", english: "Al-Mursalat", translation: "The Emissaries", verses: 50 },
            { number: 78, arabic: "النبإ", english: "An-Naba", translation: "The Tidings", verses: 40 },
            { number: 79, arabic: "النازعات", english: "An-Nazi'at", translation: "Those who drag forth", verses: 46 },
            { number: 80, arabic: "عبس", english: "'Abasa", translation: "He Frowned", verses: 42 },
            { number: 81, arabic: "التكوير", english: "At-Takwir", translation: "The Overthrowing", verses: 29 },
            { number: 82, arabic: "الإنفطار", english: "Al-Infitar", translation: "The Cleaving", verses: 19 },
            { number: 83, arabic: "المطففين", english: "Al-Mutaffifin", translation: "The Defrauding", verses: 36 },
            { number: 84, arabic: "الإنشقاق", english: "Al-Inshiqaq", translation: "The Sundering", verses: 25 },
            { number: 85, arabic: "البروج", english: "Al-Buruj", translation: "The Mansions of the Stars", verses: 22 },
            { number: 86, arabic: "الطارق", english: "At-Tariq", translation: "The Nightcommer", verses: 17 },
            { number: 87, arabic: "الأعلى", english: "Al-A'la", translation: "The Most High", verses: 19 },
            { number: 88, arabic: "الغاشية", english: "Al-Ghashiyah", translation: "The Overwhelming", verses: 26 },
            { number: 89, arabic: "الفجر", english: "Al-Fajr", translation: "The Dawn", verses: 30 },
            { number: 90, arabic: "البلد", english: "Al-Balad", translation: "The City", verses: 20 },
            { number: 91, arabic: "الشمس", english: "Ash-Shams", translation: "The Sun", verses: 15 },
            { number: 92, arabic: "الليل", english: "Al-Layl", translation: "The Night", verses: 21 },
            { number: 93, arabic: "الضحى", english: "Ad-Duhaa", translation: "The Morning Hours", verses: 11 },
            { number: 94, arabic: "الشرح", english: "Ash-Sharh", translation: "The Relief", verses: 8 },
            { number: 95, arabic: "التين", english: "At-Tin", translation: "The Fig", verses: 8 },
            { number: 96, arabic: "العلق", english: "Al-'Alaq", translation: "The Clot", verses: 19 },
            { number: 97, arabic: "القدر", english: "Al-Qadr", translation: "The Power", verses: 5 },
            { number: 98, arabic: "البينة", english: "Al-Bayyinah", translation: "The Clear Proof", verses: 8 },
            { number: 99, arabic: "الزلزلة", english: "Az-Zalzalah", translation: "The Earthquake", verses: 8 },
            { number: 100, arabic: "العاديات", english: "Al-'Adiyat", translation: "The Courser", verses: 11 },
            { number: 101, arabic: "القارعة", english: "Al-Qari'ah", translation: "The Calamity", verses: 11 },
            { number: 102, arabic: "التكاثر", english: "At-Takathur", translation: "The Rivalry in world increase", verses: 8 },
            { number: 103, arabic: "العصر", english: "Al-'Asr", translation: "The Declining Day", verses: 3 },
            { number: 104, arabic: "الهمزة", english: "Al-Humazah", translation: "The Traducer", verses: 9 },
            { number: 105, arabic: "الفيل", english: "Al-Fil", translation: "The Elephant", verses: 5 },
            { number: 106, arabic: "قريش", english: "Quraysh", translation: "Quraysh", verses: 4 },
            { number: 107, arabic: "الماعون", english: "Al-Ma'un", translation: "The Small kindnesses", verses: 7 },
            { number: 108, arabic: "الكوثر", english: "Al-Kawthar", translation: "The Abundance", verses: 3 },
            { number: 109, arabic: "الكافرون", english: "Al-Kafirun", translation: "The Disbelievers", verses: 6 },
            { number: 110, arabic: "النصر", english: "An-Nasr", translation: "The Divine Support", verses: 3 },
            { number: 111, arabic: "المسد", english: "Al-Masad", translation: "The Palm Fiber", verses: 5 },
            { number: 112, arabic: "الإخلاص", english: "Al-Ikhlas", translation: "Sincerity", verses: 4 },
            { number: 113, arabic: "الفلق", english: "Al-Falaq", translation: "Daybreak", verses: 5 },
            { number: 114, arabic: "الناس", english: "An-Nas", translation: "Mankind", verses: 6 }
        ];

        let currentSurah = null;
        let currentAyahNumber = 1;
        let surahData = null;

        window.onload = () => {
            populateSurahDropdown();
            checkResumeReading();
            setupAutoPlay();
        };

        function populateSurahDropdown() {
            const select = document.getElementById('surahSelect');
            surahNames.forEach(s => {
                const opt = new Option(`${s.number}. ${s.english} (${s.arabic})`, s.number);
                select.add(opt);
            });
        }

        async function loadSurah(startAyah = 1) {
            const num = document.getElementById('surahSelect').value;
            if (!num) return;

            currentSurah = parseInt(num);
            currentAyahNumber = startAyah;
            const display = document.getElementById('ayahDisplay');
            display.innerHTML = '<div class="text-center py-5"><i class="fas fa-spinner fa-spin fa-2x"></i></div>';

            try {
                // Fetch Audio and Arabic text together
                const resAr = await fetch(`https://api.alquran.cloud/v1/surah/${num}/ar.alafasy`);
                const dataAr = await resAr.json();

                // Fetch English Translation
                const resEn = await fetch(`https://api.alquran.cloud/v1/surah/${num}/en.asad`);
                const dataEn = await resEn.json();

                // Fetch Malayalam Translation
                const resMl = await fetch(`https://api.alquran.cloud/v1/surah/${num}/ml.abdulhameed`);
                const dataMl = await resMl.json();

                surahData = {
                    arabic: dataAr.data,
                    english: dataEn.data,
                    malayalam: dataMl.data
                };
                displayAyah();
            } catch (e) {
                display.innerHTML = '<p class="text-danger text-center">Failed to load content.</p>';
            }
        }

        function displayAyah(autoPlay = false) {
            const idx = currentAyahNumber - 1;
            const ar = surahData.arabic.ayahs[idx];
            const en = surahData.english.ayahs[idx];
            const ml = surahData.malayalam.ayahs[idx];
            const info = surahNames.find(s => s.number === currentSurah);
            const juz = ar.juz;

            // Base Arabic text for the ayah
            let text = ar.text;

            // Remove Bismillah from the first ayah of all surahs except 1 and 9
            // Surah 1 keeps Bismillah inside the first ayah (no separate header).
            if (currentAyahNumber === 1 && currentSurah !== 1 && currentSurah !== 9) {
                // Common written variants (with/without small diacritics)
                const bismVariants = [
                    "بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ",
                    "بِسْمِ ٱللَّهِ ٱلرَّحْمَٰنِ ٱلرَّحِيمِ",
                    "بِسْمِ اللهِ الرَّحْمٰنِ الرَّحِيْمِ",
                    "بِسْمِ اللَّهِ الرَّحْمَنِ الرَّحِيمِ",
                    "بِسْمِ اللّٰهِ الرَّحْمٰنِ الرَّحِيْمِ"
                ];

                let cleaned = text;

                // Try to strip known full-phrase variants at the start
                for (const phrase of bismVariants) {
                    if (cleaned.startsWith(phrase)) {
                        cleaned = cleaned.slice(phrase.length).trim();
                        break;
                    }
                }

                // Fallback: if it still starts with "بسم" and contains "الرحيم",
                // cut everything from beginning through the first "الرحيم".
                if (cleaned.startsWith("بسم") || cleaned.startsWith("بِسْم")) {
                    const rahimIdx = cleaned.indexOf("الرحيم");
                    if (rahimIdx !== -1) {
                        cleaned = cleaned.slice(rahimIdx + "الرحيم".length).trim();
                    }
                }

                text = cleaned;
            }

            // Show Bismillah header for first ayah of every surah except 1 and 9
            const showBismHeader = (currentAyahNumber === 1 && currentSurah !== 1 && currentSurah !== 9);
            const bismHeader = showBismHeader
                ? `<div class="ayah-arabic" style="font-size:2rem; color:#1a7a70; background: transparent; box-shadow: none; padding: 0; margin-bottom: 10px;">بِسْمِ اللَّهِ الرَّحْمَٰنِ الرَّحِيمِ</div>`
                : '';

            document.getElementById('ayahDisplay').innerHTML = `
                <div class="surah-info">
                    <h3>${info.english} - ${info.arabic}</h3>
                    <p class="small text-muted">${info.translation}</p>
                    <div class="mt-2 text-white-50" style="font-size: 0.9rem;">
                        <span class="badge rounded-pill bg-teal me-2" style="background-color: rgba(26, 122, 112, 0.5); border: 1px solid rgba(255,255,255,0.2);">Juz ${juz} / 30</span>
                        <span>Ayah ${currentAyahNumber} / ${info.verses}</span>
                    </div>
                </div>
                
                <div class="audio-wrapper">
                    <button id="customPlayBtn" class="play-btn" onclick="toggleAudio()">
                        <i class="fas fa-play" id="playIcon"></i>
                    </button>
                    <audio id="mainAudio" style="display:none;" onended="resetPlayIcon()">
                        <source src="${ar.audio}" type="audio/mpeg">
                    </audio>
                </div>

                ${bismHeader}
                <div class="ayah-arabic">${text}</div>
                <div class="ayah-translation" style="margin-bottom: 15px;">
                    <strong style="color: #1a7a70; font-size: 0.9rem;">English:</strong><br>
                    ${en.text}
                </div>
                <div class="ayah-translation" style="font-family: 'Noto Sans Malayalam', sans-serif;">
                    <strong style="color: #1a7a70; font-size: 0.9rem;">മലയാളം:</strong><br>
                    ${ml.text}
                </div>
            `;

            document.getElementById('prevBtn').disabled = currentAyahNumber === 1;
            document.getElementById('nextBtn').disabled = currentAyahNumber === info.verses;

            if (autoPlay) {
                toggleAudio();
            }

            saveProgress();
        }

        function toggleAudio() {
            const audio = document.getElementById('mainAudio');
            const icon = document.getElementById('playIcon');

            if (audio.paused) {
                audio.play();
                icon.className = 'fas fa-pause';
            } else {
                audio.pause();
                icon.className = 'fas fa-play';
            }
        }

        function resetPlayIcon() {

            nextAyah(true);
        }

        function nextAyah(autoPlay = false) {
            const info = surahNames.find(s => s.number === currentSurah);
            if (currentAyahNumber < info.verses) {
                currentAyahNumber++;
                displayAyah(autoPlay);
            } else {
                // End of surah, reset icon
                document.getElementById('playIcon').className = 'fas fa-play';
            }
        }

        function previousAyah() {
            if (currentAyahNumber > 1) {
                currentAyahNumber--;
                displayAyah();
            }
        }

        function saveProgress() {
            localStorage.setItem('quranProgress', JSON.stringify({
                surah: currentSurah,
                ayah: currentAyahNumber
            }));
        }

        function checkResumeReading() {
            const saved = localStorage.getItem('quranProgress');
            if (saved) {
                const p = JSON.parse(saved);
                document.getElementById('resumeText').innerText = `Surah ${p.surah}, Ayah ${p.ayah}`;
                document.getElementById('resumeBanner').style.display = 'flex';
            }
        }

        function resumeReading() {
            const p = JSON.parse(localStorage.getItem('quranProgress'));
            document.getElementById('surahSelect').value = p.surah;
            loadSurah(p.ayah);
            closeResumeBanner();
        }

        function closeResumeBanner() {
            document.getElementById('resumeBanner').style.display = 'none';
        }
    </script>
</body>

</html>